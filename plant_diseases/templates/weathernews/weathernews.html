<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Prediction - ACI AgriGPT</title>
    <style>
        /* custom_css ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ CSS */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0; /* Add padding to body, remove from gradio-container */
        }
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            padding: 0px;
            overflow: hidden;
        }
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end; /* Align items at the bottom */
        }
        .form-group {
            flex: 1;
            min-width: 200px; /* Minimum width for form elements */
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        .form-group select, .form-group button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-group button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            height: 42px; /* Make button height consistent with dropdowns */
        }
        .form-group button:hover {
            background-color: #218838;
        }

        .summary-cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* Gap between cards */
            margin-bottom: 20px;
        }
        .summary-card-item {
            flex: 1;
            min-width: 150px; /* Minimum width for each card */
            max-width: calc(16.66% - 10px); /* Adjust based on gap for 6 cards in a row */
            box-sizing: border-box;
        }

        /* Gradio original css replacement from previous code */
        .summary-card-content {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            background-color: #f9fbfd;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1em;
            font-weight: 500;
            height: 100%;
        }
        .summary-card-content .icon {
            font-size: 2em;
            margin-bottom: 5px;
            color: #007bff;
        }

        /* Specific icon colors */
        #max_temp_card .icon { color: #dc3545; }
        #min_temp_card .icon { color: #007bff; }  
        #avg_temp_card .icon { color: #dc3545; }
        #avg_rainfall_card .icon { color: #007bff; }
        #avg_humidity_card .icon { color: #28a745; }
        #avg_wind_card .icon { color: #6c757d; }

        .summary-card-content .gr-text {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }
        .summary-card-content .gr-text-output {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }
        .summary-card-content .wind-description {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
            text-align: left;
            max-width: 100%;
            overflow-wrap: break-word;
        }


        .detailed-forecast-table-container {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        .detailed-forecast-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
            color: #333;
        }
        .detailed-forecast-table th,
        .detailed-forecast-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            text-align: left;
        }
        .detailed-forecast-table th {
            background-color: #f0f2f5;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            font-size: 0.85em;
        }
        .detailed-forecast-table tbody tr:nth-child(even) {
            background-color: #f9fbfd;
        }
        .detailed-forecast-table tbody tr:hover {
            background-color: #e6f7ff;
        }

        .detailed-forecast-table .temp-hl-value {
            color: #dc3545;
            font-weight: bold;
        }
        .detailed-forecast-table .rainfall-value {
            color: #007bff;
            font-weight: bold;
        }
        .detailed-forecast-table .agri-impact-value {
            color: #ffc107;
            font-weight: 500;
        }

        .detailed-forecast-table .table-data-text {
            color: #333;
        }

        h2 {
            color: #333;
            font-size: 1.8em;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .header-bar {
            background-color: #28a745;
            color: white;
            padding: 15px 20px;
            font-size: 1.8em;
            font-weight: bold;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-bar .title {
            margin-left: 20px;
        }
        .header-bar .logo {
            font-size: 0.7em;
            opacity: 0.8;
        }
        .back-to-home {
            font-size: 0.6em;
            opacity: 0.8;
            cursor: pointer;
            text-decoration: underline;
            color: white; /* Ensure link color is visible */
        }
        .content-padding {
            padding: 0px 20px 20px 20px;
        }

        /* Loader CSS */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: red;
            background-color: #ffebeb;
            border: 1px solid #ff0000;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            display: none; /* Hidden by default */
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            .form-group {
                min-width: 100%;
            }
            .summary-card-item {
                max-width: calc(50% - 5px); /* 2 cards per row on small screens */
            }
        }
        @media (max-width: 480px) {
            .summary-card-item {
                max-width: 100%; /* 1 card per row on very small screens */
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-bar">
            <a href="{% url 'home' %}" class="back-to-home">‚Üê Back to Home</a> <span class="title">Weather Prediction</span>
            <span class="logo">ACI AgriGPT</span>
        </div>

        <div class="content-padding">
            <h2>Weather Filters</h2>
            <form id="weather-form" class="form-row">
                <div class="form-group">
                    <label for="district-select">Region (District)</label>
                    <select id="district-select" name="district">
                        {% for district in districts %}
                            <option value="{{ district }}" {% if district == "‡¶¢‡¶æ‡¶ï‡¶æ" %}selected{% endif %}>{{ district }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="date-range-select">Date Range</label>
                    <select id="date-range-select" name="date_range">
                        {% for drange in date_ranges %}
                            <option value="{{ drange }}" {% if drange == "Next 7 Days" %}selected{% endif %}>{{ drange }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <button type="submit" id="get-forecast-button">Get Forecast</button>
                </div>
            </form>

            <div id="error-message" class="error-message"></div>

            <hr>

            <h2>Current Day Summary</h2>
            <div class="summary-cards-container">
                <div class="summary-card-item">
                    <div class="summary-card-content" id="max_temp_card"><div class="icon">üî∫</div><span class="gr-text">Max Temperature</span><br><span class="gr-text-output" id="max_temp_output">N/A</span></div>
                </div>
                <div class="summary-card-item">
                    <div class="summary-card-content" id="min_temp_card"><div class="icon">üîª</div><span class="gr-text">Min Temperature</span><br><span class="gr-text-output" id="min_temp_output">N/A</span></div>
                </div>
                <div class="summary-card-item">
                    <div class="summary-card-content" id="avg_temp_card"><div class="icon">üå°Ô∏è</div><span class="gr-text">Avg Temperature</span><br><span class="gr-text-output" id="avg_temp_output">N/A</span></div>
                </div>
                <div class="summary-card-item">
                    <div class="summary-card-content" id="avg_rainfall_card"><div class="icon">üåßÔ∏è</div><span class="gr-text">Avg Rainfall</span><br><span class="gr-text-output" id="avg_rainfall_output">N/A</span></div>
                </div>
                <div class="summary-card-item">
                    <div class="summary-card-content" id="avg_humidity_card"><div class="icon">üíß</div><span class="gr-text">Avg Humidity</span><br><span class="gr-text-output" id="avg_humidity_output">N/A</span></div>
                </div>
                <div class="summary-card-item">
                    <div class="summary-card-content" id="avg_wind_card"><div class="icon">üí®</div><span class="gr-text">Avg Wind Speed</span><br><span class="gr-text-output" id="avg_wind_output">N/A</span><br><span class="wind-description" id="wind_description_output">No description available.</span></div>
                </div>
            </div>

            <h2>Detailed Forecast</h2>
            <p>Weather predictions for agricultural planning.</p>
            
            <div class="detailed-forecast-table-container">
                <table class="detailed-forecast-table">
                    <thead>
                        <tr>
                            <th>DATE</th>
                            <th>TEMP (H/L)</th>
                            <th>CONDITION</th>
                            <th>RAINFALL</th>
                            <th>HUMIDITY</th>
                            <th>WIND</th>
                            <th>ADVISE FOR FARMER</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-forecast-table-body">
                        <tr><td colspan="7" style="text-align: center;">Select a district and date range to see the forecast.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="loader-overlay" id="loader-overlay">
        <div class="loader"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('weather-form');
            const districtSelect = document.getElementById('district-select');
            const dateRangeSelect = document.getElementById('date-range-select');
            const maxTempOutput = document.getElementById('max_temp_output');
            const minTempOutput = document.getElementById('min_temp_output');
            const avgTempOutput = document.getElementById('avg_temp_output');
            const avgRainfallOutput = document.getElementById('avg_rainfall_output');
            const avgHumidityOutput = document.getElementById('avg_humidity_output');
            const avgWindOutput = document.getElementById('avg_wind_output');
            const windDescriptionOutput = document.getElementById('wind_description_output');
            const detailedForecastTableBody = document.getElementById('detailed-forecast-table-body');
            const loaderOverlay = document.getElementById('loader-overlay');
            const errorMessageDiv = document.getElementById('error-message');

            // Helper function to get condition icon
            function getConditionIcon(conditionText) {
                if (conditionText.includes("Sunny") || conditionText.includes("‡¶∞‡ßå‡¶¶‡ßç‡¶∞‡ßã‡¶ú‡ßç‡¶ú‡ßç‡¶¨‡¶≤")) {
                    return "‚òÄÔ∏è";
                } else if (conditionText.includes("Cloudy") || conditionText.includes("‡¶Æ‡ßá‡¶ò‡¶≤‡¶æ") || conditionText.includes("Partly Cloudy")) {
                    return "‚òÅÔ∏è";
                } else if (conditionText.includes("Rain") || conditionText.includes("‡¶¨‡ßÉ‡¶∑‡ßç‡¶ü‡¶ø") || conditionText.includes("Moderate Rain") || conditionText.includes("Heavy Rain")) {
                    return "üåßÔ∏è";
                } else if (conditionText.includes("Thunderstorm") || conditionText.includes("‡¶¨‡¶ú‡ßç‡¶∞‡¶™‡¶æ‡¶§")) {
                    return "‚õàÔ∏è";
                } else {
                    return "‚ùì";
                }
            }

            // Function to display error message
            function showErrorMessage(message) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
            }

            // Function to hide error message
            function hideErrorMessage() {
                errorMessageDiv.style.display = 'none';
            }

            // Function to update UI with fetched data
            function updateUI(data) {
                const currentSummary = data.current_summary;
                const dailyForecasts = data.daily_forecast;

                // Update summary cards
                maxTempOutput.textContent = currentSummary.max_temperature || 'N/A';
                minTempOutput.textContent = currentSummary.min_temperature || 'N/A';
                avgTempOutput.textContent = currentSummary.avg_temperature || 'N/A';
                avgRainfallOutput.textContent = currentSummary.rainfall || 'N/A';
                avgHumidityOutput.textContent = currentSummary.humidity || 'N/A';
                avgWindOutput.textContent = currentSummary.wind_speed || 'N/A';
                windDescriptionOutput.textContent = currentSummary.wind_description || 'No description available.';

                // Update detailed forecast table
                let tableRowsHtml = '';
                if (dailyForecasts && dailyForecasts.length > 0) {
                    dailyForecasts.forEach(dayData => {
                        const conditionIcon = getConditionIcon(dayData.condition || "");
                        tableRowsHtml += `
                            <tr>
                                <td class='table-data-text'>${dayData.date || 'N/A'}</td>
                                <td class='temp-hl-value'>${dayData.max_min_temp || 'N/A'}</td>
                                <td class='table-data-text'>${conditionIcon} ${dayData.condition || 'N/A'}</td>
                                <td><span class='rainfall-value'>${dayData.rainfall || 'N/A'}</span></td>
                                <td class='table-data-text'>${dayData.humidity || 'N/A'}</td>
                                <td class='table-data-text'>${dayData.wind_speed_direction || 'N/A'}</td>
                                <td><span class='agri-impact-value'>${dayData.farmer_advice || 'N/A'}</span></td>
                            </tr>
                        `;
                    });
                } else {
                    tableRowsHtml = '<tr><td colspan="7" style="text-align: center;">No detailed forecast available.</td></tr>';
                }
                detailedForecastTableBody.innerHTML = tableRowsHtml;
            }

            // Event listener for form submission
            form.addEventListener('submit', async function(event) {
                event.preventDefault(); // Prevent default form submission

                hideErrorMessage();
                loaderOverlay.style.display = 'flex'; // Show loader

                const district = districtSelect.value;
                const dateRange = dateRangeSelect.value;

                try {
                    // Correct URL for the Django view
                    const response = await fetch('{% url "weathernews:get_and_save_weather_data" %}', { {# ‡¶è‡¶á ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá #}
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            // Django CSRF token is not strictly needed due to @csrf_exempt in views.py
                            // However, for better security in production, consider implementing
                            // proper CSRF token handling or token-based API authentication.
                        },
                        body: JSON.stringify({
                            location: district,
                            date_range: dateRange
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const data = await response.json();

                    if (data.status === 'success') {
                        updateUI(data);
                    } else {
                        showErrorMessage(`Error: ${data.message || 'Unknown error occurred.'}`);
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    showErrorMessage(`Failed to fetch weather data. Please try again. (${error.message})`);
                } finally {
                    loaderOverlay.style.display = 'none'; // Hide loader
                }
            });

            // Initial load of data (optional, remove if you don't want data on first load)
            // You can trigger the form submission programmatically if you want initial data
            // For example, to load data for default selected district and date range on page load:
            // form.dispatchEvent(new Event('submit'));
        });
    </script>
</body>
</html>